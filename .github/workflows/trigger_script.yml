name: CSX Stock Tracker

on:
  repository_dispatch:
    types: [ping_15s]
  workflow_dispatch:

jobs:
  run-tracker:
    name: "ðŸš€ Run Stock Tracking"
    runs-on: ubuntu-latest
    outputs:
      # Exporting the data so Job 2 can use it
      callback_data: ${{ steps.tracker_step.outputs.callback_data }}
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Setup Python 3.10
        id: setup_python
        uses: actions/setup-python@v5 # Upgraded to v5 for better reliability
        with:
          python-version: '3.10'
          cache: 'pip'

      - name: Install Dependencies
        if: steps.setup_python.outputs.cache-hit != 'true'
        run: |
          if [ -f requirements.txt ]; then
            pip install -r requirements.txt
          fi

      - name: Execute Tracker Script
        id: tracker_step
        env:
          BOT_TOKEN: ${{ secrets.BOT_TOKEN }}
          SEND_CHAT_ID: ${{ github.event.client_payload.chat_id || secrets.SEND_CHAT_ID }}
        run: python my_script.py

      - name: Persist State Changes
        if: success() # Only save if the script succeeded
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git add log.txt state.json
          # Use 'git commit' with a check to prevent errors if nothing changed
          git diff --quiet && git diff --staged --quiet || (git commit -m "Update tracker state [skip ci]" && git push)

  callback:
    name: "ðŸ“¢ Send Notifications"
    runs-on: ubuntu-latest
    needs: run-tracker
    # if: always() # Optional: Run even if tracker fails to send error alerts
    steps:
      - name: HTTP API Callback
        # This sends the raw JSON to your custom endpoint
        run: |
          curl -X POST "${{ secrets.CALLBACK_URL }}" \
          -H "Content-Type: application/json" \
          -d '{
            "status": "success",
            "data": ${{ needs.run-tracker.outputs.callback_data || "[]" }}
          }'

      - name: Telegram Notification
        env:
          BOT_TOKEN: ${{ secrets.BOT_TOKEN }}
          CHAT_ID: ${{ github.event.client_payload.chat_id || secrets.SEND_CHAT_ID }}
          RAW_DATA: ${{ needs.run-tracker.outputs.callback_data }}
        run: |
          # Formatted message with MarkdownV2 escaping logic or simple Markdown
          # We use a heredoc to keep the MESSAGE clean
          MESSAGE="ðŸ“Š *CSX Status: Success*%0A%0A*Result:*%0A\`${RAW_DATA}\`"
          
          curl -s -X POST "https://api.telegram.org/bot${BOT_TOKEN}/sendMessage" \
          -d "chat_id=${CHAT_ID}" \
          -d "text=${MESSAGE}" \
          -d "parse_mode=Markdown"

# name: CSX Stock Tracker

# on:
#   repository_dispatch:
#     types: [ping_15s]
#   workflow_dispatch:

# jobs:
#   run-tracker:
#     runs-on: ubuntu-latest
#     outputs:
#       callback_data: ${{ steps.tracker_step.outputs.callback_data }}
#     steps:
#       - name: Checkout
#         uses: actions/checkout@v4

#       - name: Setup Python
#         uses: actions/setup-python@v4
#         with:
#           python-version: '3.10'
#           cache: 'pip' # <--- This automatically caches your requirements

#       - name: Install dependencies
#         # This line says: "Only run this if the cache was NOT found"
#         if: steps.setup-python.outputs.cache-hit != 'true'
#         run: |
#           pip install -r requirements.txt

#       - name: Run Script
#         id: tracker_step
#         env:
#           BOT_TOKEN: ${{ secrets.BOT_TOKEN }}
#           SEND_CHAT_ID: ${{ github.event.client_payload.chat_id || secrets.SEND_CHAT_ID }}
#         run: python my_script.py

#       - name: Save State
#         run: |
#           git config --global user.name "github-actions[bot]"
#           git config --global user.email "github-actions[bot]@users.noreply.github.com"
#           git add log.txt state.json
#           git commit -m "Update tracker state [skip ci]" || exit 0
#           git push

#   callback:
#     runs-on: ubuntu-latest
#     needs: run-tracker
#     steps:
#       - name: Callback
#         # if: steps.tracker_step.outputs.callback_data != '[]' # Only run if stocks were found
#         run: |
#           curl -X POST "${{ secrets.CALLBACK_URL || 'https://youtube.com/trigger_callback' }}" \
#           -H "Content-Type: application/json" \
#           -d '{
#             "status": "success",
#             "data": ${{ needs.run-tracker.outputs.callback_data || '[]' }}
#           }'
#       - name: Send Telegram Message
#         env:
#           BOT_TOKEN: ${{ secrets.BOT_TOKEN }}
#           # Use the chat_id from the trigger payload, or fallback to your secret
#           CHAT_ID: ${{ github.event.client_payload.chat_id || secrets.SEND_CHAT_ID }}
#         run: |
#           MESSAGE="ðŸ“Š *CSX Status: Success*"
          
#           curl -X POST "https://api.telegram.org/bot${BOT_TOKEN}/sendMessage" \
#           -H "Content-Type: application/json" \
#           -d "{
#             \"chat_id\": \"${CHAT_ID}\",
#             \"text\": \"${MESSAGE}\",
#             \"parse_mode\": \"Markdown\"
#           }"